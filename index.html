<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISF Online - Home</title>
    <link rel="icon" type="image/png" href="assets/ISF_favicon.png">
    <link rel="icon" type="image/png" href="assets/ISF_tab_logo.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&family=Cinzel:wght@700&display=swap" rel="stylesheet">

    <script>
        if (!localStorage.getItem('isf_username')) {
            window.location.href = 'login.html';
        }
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="firebase-init.js"></script>
    <script src="elo-engine.js"></script>

    <style>
        /* Extra styles for the new User Panel in the sidebar */
        .user-panel {
            background: #111;
            border: 1px solid #00ccff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(0, 204, 255, 0.1);
        }
        .user-welcome { color: #888; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
        .user-name-display { color: white; font-size: 1.4rem; font-weight: 900; margin: 5px 0; text-transform: uppercase; font-style: italic; }
        .user-stats-row { display: flex; justify-content: center; gap: 15px; margin: 10px 0; border-top: 1px solid #333; border-bottom: 1px solid #333; padding: 10px 0; }
        .stat-box { text-align: center; }
        .stat-box span { display: block; }
        .sb-label { font-size: 0.65rem; color: #666; }
        .sb-val { font-size: 1.1rem; font-weight: bold; color: #00ccff; }
        
        .btn-logout-small {
            background: transparent; border: 1px solid #333; color: #555;
            font-size: 0.7rem; padding: 5px 12px; cursor: pointer;
            text-transform: uppercase; transition: 0.2s;
        }
        .btn-logout-small:hover { color: #ff4444; border-color: #ff4444; }
    </style>
</head>
<body>

    <div class="app-container">
        
        <nav class="sidebar-left">
            <div class="logo-area-sidebar">
                <img src="assets/ISF_ONLINE.png" alt="ISF Online" class="sidebar-logo">
            </div>

            <ul class="nav-links">
                <li class="active"><a href="#">Home</a></li>
                <li><a href="how-to-play.html">How to Play</a></li>
                <li><a href="https://sprucewilliams.github.io/Slaps-Online/matchtable.html">Game History</a></li>
                <li><a href="leaderboard.html">Leaderboard</a></li>
                <li><a href="assets/SLAPS rules and regs v1.2-compressed.pdf" target="_blank">Rules & Regs</a></li>
            </ul>

            <div class="sidebar-footer">
                <li><a href="#">Settings</a></li>
                <li><a href="report-bug.html">Report a Bug</a></li>
            </div>
        </nav>

        <main class="hero-area">
            <div class="card-display">
                <img src="assets/cards/ace_of_hearts.png" alt="Ace of Hearts" class="hero-card-img">
            </div>
        </main>

        <aside class="sidebar-right">
            
            <div class="user-panel">
                <div class="user-welcome">Welcome Back</div>
                <div class="user-name-display" id="disp-username">LOADING...</div>
                
                <div class="user-stats-row">
                    <div class="stat-box">
                        <span class="sb-val" id="disp-elo">---</span>
                        <span class="sb-label">RATING</span>
                    </div>
                    <div class="stat-box">
                        <span class="sb-val" id="disp-wins">---</span>
                        <span class="sb-label">WINS</span>
                    </div>
                    <div class="stat-box">
                        <span class="sb-val" id="disp-country">---</span>
                        <span class="sb-label">NATION</span>
                    </div>
                </div>

                <button class="btn-logout-small" onclick="logout()">Log Out</button>
            </div>

            <div class="modes-grid">
                
                <div class="mode-box" onclick="window.location.href='multiplayer-setup.html'">
                    <div class="mode-icon">
                        <i class="fa-solid fa-handshake"></i>
                    </div>
                    <h3>PLAY A<br>FRIEND</h3>
                    <button class="btn-mode-play">PLAY</button>
                </div>

                <div class="mode-box" onclick="window.location.href='setup.html'">
                    <div class="mode-icon">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <h3>PLAY AI<br>BOT</h3>
                    <button class="btn-mode-play">PLAY</button>
                </div>

                <div class="mode-box" onclick="window.location.href='matchmaking.html'">
                    <div class="mode-icon">
                        <i class="fa-solid fa-globe"></i>
                    </div>
                    <h3>PLAY<br>ONLINE</h3>
                    <button class="btn-mode-play">PLAY</button>
                </div>

                <div class="mode-box" onclick="window.location.href='tournament-setup.html'">
                    <div class="mode-icon">
                        <i class="fa-solid fa-trophy"></i>
                    </div>
                    <h3>PLAY<br>TOURNAMENT</h3>
                    <button class="btn-mode-play">PLAY</button>
                </div>

               <div class="mode-box" onclick="window.location.href='leaderboard.html'">
    <div class="mode-icon">
        <i class="fa-solid fa-chart-simple"></i>
    </div>
    <h3>GLOBAL<br>RANKINGS</h3>
    <button class="btn-mode-play">VIEW</button>
</div>
            </div>
        </aside>

    </div>

    <script>
        // 1. Load Username immediately from storage
        const localName = localStorage.getItem('isf_username');
        if(localName) document.getElementById('disp-username').innerText = localName;

        // 2. Fetch Live Stats from Firebase
        auth.onAuthStateChanged((user) => {
            if (user) {
                const userRef = db.ref('users/' + user.uid);
                userRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if(data) {
                        document.getElementById('disp-elo').innerText = data.elo || 1000;
                        document.getElementById('disp-wins').innerText = data.wins || 0;
                        document.getElementById('disp-country').innerText = data.country || "---";
                    }
                });
            }
        });

        // 3. Logout Logic
        function logout() {
            auth.signOut().then(() => {
                localStorage.clear();
                window.location.href = 'login.html';
            });
        }
        // --- MATCH REPORTER ---

/**
 * Call this function when a Ranked Game ends.
 * @param {number} opponentElo - The rating of the person you fought.
 * @param {number} opponentGameCount - How many games they have played (for the halving rule).
 * @param {boolean} isWin - true if you won, false if you lost.
 */
function reportMatchResult(opponentElo, opponentGameCount, isWin) {
    const user = auth.currentUser;
    if (!user) return; // Safety check

    console.log("Reporting Match... Win:", isWin);

    const userRef = db.ref('users/' + user.uid);

    // Use a transaction to safely update stats without glitches
    userRef.transaction((userData) => {
        if (userData) {
            // 1. Get current stats (default to 1000/0/0 if missing)
            const currentElo = userData.elo || 1000;
            const wins = userData.wins || 0;
            const losses = userData.losses || 0;
            
            // Calculate MY total games played so we know which K-Factor to use
            const myGameCount = wins + losses;

            // 2. Calculate New ELO using our engine file
            const newElo = calculateNewElo(
                currentElo, 
                opponentElo, 
                isWin, 
                myGameCount, 
                opponentGameCount 
            );

            // 3. Update the data to save to Firebase
            userData.elo = newElo;
            if (isWin) {
                userData.wins = wins + 1;
            } else {
                userData.losses = losses + 1;
            }
            
            return userData; // Saves the changes
        }
        return userData;
    });
}
    </script> 
</body>
</html>
