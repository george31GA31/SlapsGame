<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISF - Tournament Lobby</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        body {
            background-color: #1a1a1a;
            background-image: radial-gradient(circle at center, #2a2a2a 0%, #000000 100%);
            color: white;
            font-family: 'Roboto', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }

        .container { width: 90%; max-width: 900px; text-align: center; }
        
        /* CARDS */
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card {
            background: rgba(0,0,0,0.6); border: 1px solid #333; border-radius: 15px;
            padding: 30px; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); transition: 0.2s;
        }
        .card.large { grid-row: span 2; justify-content: center; }
        
        /* INPUTS & BUTTONS */
        input {
            background: rgba(255,255,255,0.1); border: 1px solid #444; color: white;
            padding: 12px; border-radius: 8px; text-align: center; font-size: 1rem;
            width: 80%; text-transform: uppercase; font-weight: bold; margin-bottom: 15px;
        }
        .btn {
            padding: 15px 30px; font-weight: 900; border-radius: 50px; border: none;
            cursor: pointer; text-transform: uppercase; width: 80%; margin-top: 10px;
            transition: 0.2s;
        }
        .btn-blue { background: linear-gradient(135deg, #00c6ff, #0072ff); color: white; box-shadow: 0 0 15px rgba(0,114,255,0.4); }
        .btn-blue:hover { transform: scale(1.05); }
        .btn-outline { background: transparent; border: 2px solid #00ccff; color: white; }
        .btn:disabled { background: #333; color: #555; cursor: not-allowed; transform: none; box-shadow: none; }

        /* LOBBY SPECIFIC */
        .lobby-code { font-size: 3rem; color: #00ff00; letter-spacing: 3px; margin: 10px 0; font-weight: 900; }
        .player-list { width: 100%; text-align: left; margin: 20px 0; min-height: 100px; }
        .player-item { padding: 10px; border-bottom: 1px solid #333; font-weight: bold; color: #ccc; }
        .player-item i { color: #00ccff; margin-right: 10px; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="view-menu" class="grid-layout">
            
            <div class="card large">
                <i class="fa-solid fa-users" style="font-size: 3rem; color: #00ccff; margin-bottom: 15px;"></i>
                <h2>PLAY FRIENDS</h2>
                <input type="text" id="my-nick" placeholder="YOUR NICKNAME">
                
                <button class="btn btn-blue" onclick="createLobby()">HOST TOURNAMENT</button>
                <div style="margin:10px 0; color:#666; font-weight:bold;">- OR -</div>
                <button class="btn btn-outline" onclick="showJoinInput()">JOIN TOURNAMENT</button>
                
                <div id="join-area" class="hidden" style="width:100%; margin-top:15px; display:flex; flex-direction:column; align-items:center;">
                    <input type="text" id="join-code" placeholder="ENTER CODE (ISF-XXXX)">
                    <button class="btn btn-blue" onclick="joinLobby()">CONNECT</button>
                </div>
            </div>

            <div class="card">
                <i class="fa-solid fa-globe" style="font-size: 2rem; color: #00ccff;"></i>
                <h3>ONLINE</h3>
                <button class="btn btn-outline" style="font-size:0.9rem;" onclick="location.href='online-tournament.html'">FIND MATCH</button>
            </div>
            <div class="card">
                <i class="fa-solid fa-robot" style="font-size: 2rem; color: #00ccff;"></i>
                <h3>VS BOTS</h3>
                <button class="btn btn-outline" style="font-size:0.9rem;" onclick="location.href='tournament-match.html'">START</button>
            </div>
        </div>

        <div id="view-lobby" class="card hidden" style="max-width: 600px; margin: 0 auto;">
            <h2>TOURNAMENT LOBBY</h2>
            <div style="color:#888;">SHARE THIS CODE:</div>
            <div id="lobby-code-display" class="lobby-code">---</div>
            
            <div class="player-list" id="player-list-container">
                </div>

            <div id="host-controls">
                <button id="btn-start" class="btn btn-blue" onclick="startTournament()" disabled>WAITING FOR PLAYERS...</button>
            </div>
            <div id="guest-controls" class="hidden">
                <div style="color:#00ff00; font-weight:bold;">CONNECTED! WAITING FOR HOST...</div>
            </div>
            
            <button class="btn btn-outline" style="margin-top:20px; border-color:#444; color:#888;" onclick="location.reload()">LEAVE LOBBY</button>
        </div>

    </div>

    <script>
        // --- VARIABLES ---
        let myName = "";
        let peer = null;
        let connections = []; // Host keeps track of guests
        let players = [];     // List of all players [{name, id, isHost}]
        let isHost = false;
        let hostConn = null;  // Guest connection to host

        // --- NAVIGATION ---
        function showJoinInput() {
            document.getElementById('join-area').classList.remove('hidden');
        }

        function switchScreen(screenId) {
            document.getElementById('view-menu').classList.add('hidden');
            document.getElementById('view-lobby').classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
        }

        // --- HOST LOGIC ---
        function createLobby() {
            myName = document.getElementById('my-nick').value.trim() || "Host";
            const code = "ISF-" + Math.floor(1000 + Math.random() * 9000); // Generate ISF-1234

            isHost = true;
            players = [{ name: myName, id: code, isHost: true }];
            
            // Start Peer
            peer = new Peer(code);
            
            peer.on('open', (id) => {
                document.getElementById('lobby-code-display').innerText = id;
                updatePlayerList();
                switchScreen('view-lobby');
            });

            peer.on('connection', (conn) => {
                conn.on('data', (data) => {
                    // Guest wants to join
                    if (data.type === 'JOIN') {
                        const newPlayer = { name: data.name, id: data.id, isHost: false };
                        players.push(newPlayer);
                        connections.push(conn);
                        broadcastLobby(); // Tell everyone the new list
                    }
                });
            });
        }

        // --- GUEST LOGIC ---
        function joinLobby() {
            myName = document.getElementById('my-nick').value.trim() || "Guest";
            const code = document.getElementById('join-code').value.trim().toUpperCase();
            
            if(!code) return alert("Enter a code!");

            isHost = false;
            peer = new Peer(); // Random ID for me

            peer.on('open', (id) => {
                hostConn = peer.connect(code);

                hostConn.on('open', () => {
                    // Send my name to host
                    hostConn.send({ type: 'JOIN', name: myName, id: id });
                });

                hostConn.on('data', (data) => {
                    if (data.type === 'LOBBY_UPDATE') {
                        players = data.players;
                        updatePlayerList();
                        switchScreen('view-lobby');
                        document.getElementById('lobby-code-display').innerText = code;
                        document.getElementById('host-controls').classList.add('hidden');
                        document.getElementById('guest-controls').classList.remove('hidden');
                    }
                    if (data.type === 'START_GAME') {
                        // SAVE DATA AND GO!
                        saveAndGo(data.players);
                    }
                });
            });
        }

        // --- COMMON LOGIC ---
        function updatePlayerList() {
            const list = document.getElementById('player-list-container');
            list.innerHTML = '';
            players.forEach(p => {
                list.innerHTML += `<div class="player-item"><i class="fa-solid fa-user"></i> ${p.name} ${p.isHost ? '(HOST)' : ''}</div>`;
            });

            if(isHost) {
                const btn = document.getElementById('btn-start');
                // You requested 4 players minimum, change to 2 for testing if needed
                if(players.length >= 2) { 
                    btn.disabled = false;
                    btn.innerText = "START TOURNAMENT";
                } else {
                    btn.disabled = true;
                    btn.innerText = `WAITING FOR PLAYERS (${players.length}/4)`;
                }
            }
        }

        function broadcastLobby() {
            updatePlayerList();
            connections.forEach(conn => conn.send({ type: 'LOBBY_UPDATE', players: players }));
        }

        function startTournament() {
            if(!isHost) return;
            // 1. Shuffle
            const shuffled = players.sort(() => 0.5 - Math.random());
            
            // 2. Tell Guests
            connections.forEach(conn => conn.send({ type: 'START_GAME', players: shuffled }));
            
            // 3. Go
            saveAndGo(shuffled);
        }

        function saveAndGo(playerList) {
            localStorage.setItem('isf_bracket_players', JSON.stringify(playerList));
            localStorage.setItem('isf_my_name', myName);
            // We use this to return to the correct bracket logic later
            localStorage.setItem('isf_is_host', isHost);
            
            window.location.href = 'friend-tournament.html';
        }

    </script>
</body>
</html>
